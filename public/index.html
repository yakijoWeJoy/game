<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Chat</title>
</head>
<body>
    <h1>WebRTC Chat Room</h1>
    <div id="room-selection">
        <input type="text" id="room-id" placeholder="Enter Room ID">
        <button id="join-room">Join Room</button>
    </div>


    <div id="chat" style="display:none;">
        <h2>Room: <span id="current-room"></span></h2>
        <h3>paly with a freind 
            <p>Click the link below to invite:</p>
            <a id="whatsappLink" href="#" target="_blank">
                Share on WhatsApp
            </a>
        </h3>
        <textarea id="messages" rows="10" cols="50" readonly></textarea><br>
        <input type="text" id="message" placeholder="Enter message">
        <button id="send">Send</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

     
        const roomSelectionDiv = document.getElementById('room-selection');
        const chatDiv = document.getElementById('chat');
        const roomIdInput = document.getElementById('room-id');
        const joinRoomButton = document.getElementById('join-room');
        const currentRoomSpan = document.getElementById('current-room');
        const roomLink = document.getElementById('room_link');
        const messagesTextArea = document.getElementById('messages');
        const messageInput = document.getElementById('message');
        const sendButton = document.getElementById('send');
        const whatsappLink =  document.getElementById('whatsappLink');

        let roomId;

        window.onload = () => {
            //get id from querystring 
            const urlParams = new URLSearchParams(window.location.search);
          
            roomId = urlParams.get('roomId');
            if (!roomId) {
                roomId=generteId()
                generateWhatsAppLink(generteLink(roomId));
                
            }
            socket.emit('create or join', roomId);



        }
        joinRoomButton.onclick = () => {
            roomId = roomIdInput.value;
            if (roomId) {
                socket.emit('create or join', roomId);
            }
        };

        socket.on('created', (room) => {
            console.log('Created room:', room);
            currentRoomSpan.textContent = room;
            roomSelectionDiv.style.display = 'none';
            chatDiv.style.display = 'block';
        });

        socket.on('joined', (room) => {
            console.log('Joined room:', room);
            currentRoomSpan.textContent = room;
            roomSelectionDiv.style.display = 'none';
            chatDiv.style.display = 'block';
        });

        socket.on('full', (room) => {
            alert('Room is full');
        });

        sendButton.onclick = () => {
            const message = messageInput.value;
            if (message) {
                socket.emit('message', message, roomId);
                messagesTextArea.value += `You: ${message}\n`;
                messageInput.value = '';
            }
        };

        socket.on('message', (message) => {
            messagesTextArea.value += `Peer: ${message}\n`;
        });


        function generteId() {
            return   Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
           
        }

     
        function generteLink (roomId) {
            return window.location.origin + '/?roomId=' + roomId;
        }

        function generateWhatsAppLink(baseUrl) {
            
            const message = 'whatsapp';
            const encodedMessage = encodeURIComponent(`${message} ${baseUrl}`);
            const shareUrl = `https://api.whatsapp.com/send?text=${encodedMessage}`;
            whatsappLink.href = shareUrl;
            
        }
    </script>
</body>
</html>
